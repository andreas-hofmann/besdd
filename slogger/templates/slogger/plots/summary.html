{% extends 'base.html' %}

{% block head %}
  {% load static %}
  <script type="text/javascript" src="{% static 'js/lodash.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/plotly.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/vue.js' %}"></script>

  <script src="{% static 'js/vue-loading-overlay.js' %}"></script>
  <link href="{% static 'css/vue-loading.css' %}" rel="stylesheet">
{% endblock %}

{% block script %}

<script type='text/javascript'>

Vue.component('loading', VueLoading);

Vue.component('summary-entry', {
  delimiters: ['[[', ']]'],
  props: {
    summary: { type: Object, },
    day: { type: String, },
    idx: { type: Number, },
  },
  data: function() {
    return {
      initial_expand: -1, // Row to expand initially. -1 for none.
    };
  },
  methods: {
    secToHours: function(val) {
      var val = parseFloat(val);
      return (val/3600).toFixed(1);
    },
    avgTime: function(val) {
      var time = parseFloat(val.time);
      var count = parseFloat(val.count);

      if (time && count)
        return (time/3600/count).toFixed(1);

      return 0;
    },
    avgInterval: function(val) {
      var time = parseFloat(val.interval);
      var count = parseFloat(val.count);

      if (time && count)
        return (time/3600/count).toFixed(1);

      return 0;
    },
  },
  template: "#summary-entry-template",
});

var vm = new Vue({
      delimiters: ['[[', ']]'],
      el: '#app',
      data: {
        window: 7,
        from: moment().subtract({{ user.usersettings.date_range_days }}, "days").format("YYYY-MM-DD"),
        to:   moment().format("YYYY-MM-DD"),
        graph_type: "List",
        isLoading: false,
        selectRange: true,
        my_data: {},
        plots_enabled: {
          'sleep':   "{{ user.usersettings.sleep_enabled }}",
          'meals':   "{{ user.usersettings.meals_enabled }}",
          'diapers': "{{ user.usersettings.diapers_enabled }}",
        },
      },
      watch: {
        from:       function (newDate, oldDate) { this.debounce_update(); },
        to:         function (newDate, oldDate) { this.debounce_update(); },
        graph_type: function (newType, oldType) { this.updateGraph(); },
      },
      created: function () {
          this.debounce_update = _.debounce(this.updateGraph, 750);
          this.updateGraph();
      },
      methods: {
        updateDone: function() {
          this.isLoading = false;
        },
        updateGraph: function () {
            this.isLoading = true;
            plots = {
              'sleep':    this.plots_enabled.sleep == "True" ? true : "legendonly",
              'meals':    this.plots_enabled.meals == "True" ? true : "legendonly",
              'diapers':  this.plots_enabled.diapers == "True" ? true : "legendonly",
            };
            if (this.graph_type === "Timeline") {
                this.selectRange = true;
                load_time_graph("my-graph", "{% url 'summary_data_graph' child.id %}", {
                  "from": this.from, "to": this.to,
                }, {
                  "plots": plots,
                });
            } else if (this.graph_type === "Histogram") {
                this.selectRange = true;
                load_histogram("my-graph", "{% url 'histogram_data' child.id %}", {
                  "from": this.from, "to": this.to,
                }, {
                  "plots": plots,
                });
            } else if (this.graph_type === "Measurements") {
                this.selectRange = false;
                load_measurement_graph("my-graph", "{% url 'measurement_data' child.id %}", null,
                  { "doneHandler": function() {vm.updateDone();}, }
                );
            } else if (this.graph_type === "Height") {
                this.selectRange = false;
                load_percentile_graph("my-graph", "{% url 'percentile_data' child.id 'height' %}", null,
                  { "doneHandler": function() {vm.updateDone();}, }
                );
            } else if (this.graph_type === "Weight") {
                this.selectRange = false;
                load_percentile_graph("my-graph", "{% url 'percentile_data' child.id 'weight' %}", null,
                  { "doneHandler": function() {vm.updateDone();}, }
                );
            } else if (this.graph_type === "List") {
                this.selectRange = true;
                $.get("{% url 'summary_data_list' child.id %}", {"from": this.from, "to": this.to}, function (data) {
                vm.my_data = data;
                vm.updateDone();
              });
            }
        },
        move_window: function (direction) {
            this.from = moment(this.from).add(direction * this.window, "days").format("YYYY-MM-DD");
            this.to =   moment(this.to)  .add(direction * this.window, "days").format("YYYY-MM-DD");
        },
      },
});

</script>

{% endblock %}

{% block headline %}
Summary for {{ child.name }}
{% endblock %}

{% block content %}

<script type="text/x-template" id="summary-entry-template">
<div class="summary-entry">
    <div class="card">
      <div class="card-header" :id="'heading'+idx">
        <h5 class="mb-0">

          <div class="container">
            <div class="row">
              <div v-if="summary.sleep" class="col-xs small mt-2 ml-1">
                <small>Slept [[ secToHours(summary.sleep.sum.time) ]] h in [[ summary.sleep.sum.count ]] phases.</small>
              </div>

              <div v-if="summary.meals" class="col-xs small mt-2 ml-1">
                <small>[[ summary.meals.sum.count ]] meals eaten.</small>
              </div>

              <div v-if="summary.diapers" class="col-xs small mt-2 ml-1">
                <small>[[ summary.diapers.sum.count ]] diapers used.</small>
              </div>

              <div class="col-xs ml-auto">
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-link" :class="[ idx !== initial_expand ? 'collapsed' : '']" data-toggle="collapse" :data-target="'#collapse'+idx" :aria-expanded="[ idx === initial_expand ? 'true' : '' ]" :aria-controls="'collapse'+idx">
                    <i v-if="summary.diary" class="mr-2 material-icons">menu_book</i>
                    <i v-if="summary.events" class="mr-2 material-icons">cake</i>
                    <i v-if="summary.measurements" class="mr-2 material-icons">speed</i>
                    [[ day ]]
                  </button>
                </div>
              </div>
            </div>
          </div>

        </h5>
      </div>

      <div :id="'collapse'+idx" class="collapse" :class="[ idx === initial_expand ? 'show' : '']" :aria-labelledby="'heading'+idx" data-parent="#accordion">
        <div class="card-body">
          <div class="container">

            <div v-if="summary.sleep" :id="[ 'sleep'+idx ]">
              <div class="row mb-2">
                <div class="col-md"></div>
                <div class="col-md"><h3><u>Sleep</u></h3></div>
                <div class="col-md"></div>
              </div>
              <div class="row">
                <div class="col-md">
                <h5>Total:</h5>
                <p>
                  [[ secToHours(summary.sleep.sum.time) ]] hours in [[ summary.sleep.sum.count ]] phases.<br>
                  Avg. length [[ avgTime(summary.sleep.sum) ]] hours.<br />
                  Avg. interval [[ avgInterval(summary.sleep.sum) ]] hours.
                </p>
                </div>
                <div class="col-md">
                <h5>Day:</h5>
                <p>
                  [[ secToHours(summary.sleep.day.time) ]] hours in [[ summary.sleep.day.count ]] phases.<br>
                  Avg. length [[ avgTime(summary.sleep.day) ]] hours.<br />
                  Avg. interval [[ avgInterval(summary.sleep.day) ]] hours.
                </p>
                </div>
                <div class="col-md">
                <h5>Night:</h5>
                <p>
                  [[ secToHours(summary.sleep.night.time) ]] hours in [[ summary.sleep.night.count ]] phases.<br>
                  Avg. length [[ avgTime(summary.sleep.night) ]] hours.<br />
                  Avg. interval [[ avgInterval(summary.sleep.night) ]] hours.
                </p>
                </div>
              </div>
            </div>

            <div v-if="summary.meals" :id="[ 'meals'+idx ]">
              <div class="row mb-2">
                <div class="col-md"></div>
                <div class="col-md"><h3><u>Meals</u></h3></div>
                <div class="col-md"></div>
              </div>
              <div class="row">
                <div class="col-md">
                <h5>Total:</h5>
                <p>
                  [[ summary.meals.sum.count ]] meals eaten.<br>
                  Avg. interval [[ avgInterval(summary.meals.sum) ]] hours.
                </p>
                </div>
                <div class="col-md">
                <h5>Day:</h5>
                <p>
                  [[ summary.meals.day.count ]] meals eaten.<br>
                  Avg. interval [[ avgInterval(summary.meals.day) ]] hours.
                </p>
                </div>
                <div class="col-md">
                <h5>Night:</h5>
                <p>
                  [[ summary.meals.night.count ]] meals eaten.<br>
                  Avg. interval [[ avgInterval(summary.meals.night) ]] hours.
                </p>
                </div>
              </div>
            </div>

            <div v-if="summary.diapers" :id="[ 'diapers'+idx ]">
              <div class="row mb-2">
                <div class="col-md"></div>
                <div class="col-md"><h3><u>Diapers</u></h3></div>
                <div class="col-md"></div>
              </div>
              <div class="row">
                <div class="col-md">
                <h5>Total:</h5>
                <p>
                  [[ summary.diapers.sum.count ]] diapers used.<br>
                  Avg. interval [[ avgInterval(summary.diapers.sum) ]] hours.
                </p>
                </div>
                <div class="col-md">
                <h5>Day:</h5>
                <p>
                  [[ summary.diapers.day.count ]] diapers used.<br>
                  Avg. interval [[ avgInterval(summary.diapers.day) ]] hours.
                </p>
                </div>
                <div class="col-md">
                <h5>Night:</h5>
                <p>
                  [[ summary.diapers.night.count ]] diapers used.<br>
                  Avg. interval [[ avgInterval(summary.diapers.night) ]] hours.
                </p>
                </div>
              </div>
            </div>

            <div v-if="summary.measurements" :id="[ 'measurements'+idx ]">
              <div class="row">
                <div class="col-md"></div>
                <div class="col-md"><h3><u>Measurements</u></h3></div>
                <div class="col-md"></div>
              </div>
              <div v-for="measurement in summary.measurements">
                <div class="row mb-2">
                  <div v-if="measurement.height" class="col-md">
                    <h4>Height</h4>
                    <p>
                      [[ measurement.height ]]
                    </p>
                  </div>
                  <div v-if="measurement.weight" class="col-md">
                    <h4>Weight</h4>
                    <p>
                      [[ measurement.weight ]]
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <div v-if="summary.events" :id="[ 'events'+idx ]">
              <div class="row">
                <div class="col-md"></div>
                <div class="col-md"> <h3><u>Events</u></h3></div>
                <div class="col-md"></div>
              </div>
              <div v-for="event in summary.events">
                <div class="row mb-2">
                  <div class="col-md">
                    <h4>[[ event.event ]]</h4>
                    <p>
                      [[ event.description ]]
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <div v-if="summary.diary" :id="[ 'diary'+idx ]">
              <div class="row">
                <div class="col-md"></div>
                <div class="col-md"><h3><u>Diary</u></h3> </div>
                <div class="col-md"></div>
              </div>
              <div v-for="entry in summary.diary">
                <div class="row mb-2">
                  <div class="col-md">
                    <h4>[[ entry.title ]]</h4>
                    <p>
                      [[ entry.content ]]
                    </p>
                  </div>
                </div>
              </div>
            </div>


          </div>
        </div>
      </div>
    </div>
</div>
</script>

<div id="app" class="container">

    <div class="dropdown mt-3">
      <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        [[ graph_type ]]
      </button>
      <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
        <a class="dropdown-item" @click="graph_type = 'List'" href="#">List</a>
        <a class="dropdown-item" @click="graph_type = 'Timeline'" href="#">Timeline</a>
        <a class="dropdown-item" @click="graph_type = 'Histogram'" href="#">Histogram</a>
        <a class="dropdown-item" @click="graph_type = 'Measurements'" href="#">Measurements</a>
        <a class="dropdown-item" @click="graph_type = 'Height'" href="#">Height (Percentiles)</a>
        <a class="dropdown-item" @click="graph_type = 'Weight'" href="#">Weight (Percentiles)</a>
      </div>
    </div>

    <div class="my-3">
      <div v-if="graph_type == 'List'" id="my-list">
        <p v-if="my_data.avg != null" id="averages">
          Average sleep time: [[ my_data.avg.time ]] hours in [[ my_data.avg.phases ]] phases.
          Average sleep time: [[ my_data.avg.interval ]] hours.
        </p>
        <div id="accordion">
          <summary-entry v-for="(data, idx) in my_data.data" :key="data.day" :idx="idx" :day="data.day" :summary="data.data"></summary-entry>
        </div>
      </div>
      <div v-else>
        <div id="my-graph-parent">
          <loading id="my-graph-loading" :active.sync="isLoading">
          </loading>
          <div id="my-graph">
          </div>
        </div>
      </div>
    </div>

    <div v-if="selectRange" id="range-selector">
      <div class="row mb-2">
        <div class="col-xs"></div>
        <div class="col-xs-3 mx-auto">
          Select time range:
        </div>
        <div class="col-xs"></div>
      </div>

      <div class="row">
          <div class='col-xs mr-auto'></div>
          <div class="col-xs-3 mx-2">
            From:
            <div class='input-group'>
                <input v-model="from" @changed="from = $event.target.value" type='date' class="form-control" />
            </div>
          </div>
          <div class="col-xs-3 mx-2">
            To:
            <div class='input-group'>
                <input v-model="to" @changed="to = $event.target.value" type='date' class="form-control" />
            </div>
          </div>
          <div class='col-xs ml-auto'></div>
      </div>

      <div class="row">
          <div class='col-xs '></div>
          <div class='col-xs-2 mx-auto'>
            Shift time window (by days):
            <div class="input-group mb-5">
              <div @click="move_window(-1);"class="input-group-prepend1 page-link" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
                <span class="sr-only">Previous</span>
              </div>
              <input v-model="window" type='number' size='2' min='1' max='365' class="form-control" />
              <div @click="move_window(1);" class="input-group-append page-link" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
                <span class="sr-only">Next</span>
              </div>
            </div>
          </div>
          <div class='col-xs'></div>
      </div>
    </div>
</div>

{% endblock %}
